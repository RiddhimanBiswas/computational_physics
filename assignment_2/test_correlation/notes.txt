The code uses the overall variance of the entire dataset in the denominator for all lags. For large lags (e.g., 9999), the overlapping subset of data is very small (only 2 points), and their variance might differ significantly from the overall variance. The Pearson correlation formula requires normalization by the standard deviations of the two subsets being compared (original and lagged data), not the entire dataset.
